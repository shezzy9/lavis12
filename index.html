<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EVM-like Voting Prototype — LAVIS (Enhanced)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <!-- face-api.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body { background: linear-gradient(180deg,#eef6ff,#f9fbff); }
    .card { border-radius:14px; box-shadow:0 10px 30px rgba(30,40,80,0.08); }
    #video { width:100%; border-radius:8px; background:#000; }
    canvas{ border-radius:8px; }
    .small-muted{ font-size:.85rem; color:#666; }
    .status-pill{ font-weight:600; padding:6px 10px; border-radius:999px; display:inline-block; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-9 col-md-10">
        <div class="card p-4">
          <div class="d-flex align-items-center mb-3">
            <div class="me-3">
              <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:56px;height:56px;font-weight:700;">E</div>
            </div>
            <div>
              <h4 class="mb-0">EVM-like Voting Prototype — LAVIS</h4>
              <div class="small-muted">Enhanced demo: biometric unlock, encrypted storage, hash-chain & VVPAT</div>
            </div>
          </div>

          <!-- Loading Models Notice -->
          <div id="modelsNotice" class="alert alert-info mb-3">
            <strong>Loading ML models…</strong> This may take 4–12s on first load. Wait until models are Ready.
          </div>

          <!-- Step 1: Voter ID -->
          <div id="step-1" class="mb-3">
            <h5>1. Insert Smart Voter Card (simulate)</h5>
            <div class="row g-2">
              <div class="col-md-8">
                <input id="voterInput" class="form-control" placeholder="Enter Voter ID (e.g. VOTER2025_01)">
              </div>
              <div class="col-md-4 d-flex gap-2">
                <button id="btnLoadSample" class="btn btn-outline-secondary">Load Sample</button>
                <button id="btnStartAuth" class="btn btn-primary">Verify & Unlock EVM</button>
              </div>
            </div>
            <div id="voterStatus" class="mt-2"></div>
          </div>

          <!-- Step 2: Reference registration (one-time per ID) -->
          <div id="step-2" class="mb-3" style="display:none;">
            <h5>2. Register Template Photo (one-time)</h5>
            <div class="small-muted mb-2">Upload a clear frontal photo for this voter. You can also use 'Use Camera' to capture reference.</div>
            <div class="row g-2">
              <div class="col-md-6">
                <input id="refFile" type="file" accept="image/*" class="form-control mb-2">
                <button id="btnUseCameraRef" class="btn btn-outline-primary btn-sm">Use Camera to Capture Reference</button>
              </div>
              <div class="col-md-6">
                <div id="refPreview"></div>
              </div>
            </div>
            <div class="mt-2">
              <button id="btnProceedCam" class="btn btn-success">Proceed to Live Verification</button>
            </div>
          </div>

          <!-- Step 3: Live verification & EVM unlock -->
          <div id="step-3" class="mb-3" style="display:none;">
            <h5>3. Live Biometric Verification</h5>
            <div class="small-muted mb-2">Allow camera and align face in frame.</div>
            <div class="row">
              <div class="col-md-7">
                <video id="video" autoplay muted playsinline></video>
                <div class="mt-2 d-flex gap-2">
                  <button id="btnCaptureLive" class="btn btn-success">Capture</button>
                  <button id="btnRetryCapture" class="btn btn-outline-secondary">Clear</button>
                </div>
              </div>
              <div class="col-md-5">
                <div><strong>Reference</strong></div>
                <canvas id="refCanvas" width="320" height="240" style="background:#fff;"></canvas>
                <div class="mt-2"><strong>Live</strong></div>
                <canvas id="liveCanvas" width="320" height="240" style="background:#fff;"></canvas>
                <div class="mt-2" id="matchResult"></div>
              </div>
            </div>
          </div>

          <!-- Step 4: Voting Booth (EVM) -->
          <div id="step-4" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">4. EVM: Cast Your Vote</h5>
              <div id="evmLockStatus" class="status-pill bg-warning text-dark">Locked</div>
            </div>
            <div class="small-muted mb-2">EVM unlocks after successful biometric verification. Only one vote per Voter ID allowed.</div>

            <div id="evmScreen" style="display:none;">
              <div class="list-group mb-3" id="candidateArea"></div>
              <div class="d-flex gap-2">
                <button id="btnCastVote" class="btn btn-success">Cast Vote</button>
                <button id="btnCancelVote" class="btn btn-outline-secondary">Back</button>
              </div>
            </div>

            <div id="evmLockedMsg" class="alert alert-secondary">EVM is locked. Authenticate to unlock.</div>
          </div>

          <!-- Step 5: VVPAT + Receipt -->
          <div id="step-5" style="display:none;" class="mt-3">
            <h5>5. VVPAT & QR Audit Slip</h5>
            <div class="small-muted mb-2">VVPAT shows candidate name and cryptographic hash. QR encodes the vote hash (no PII).</div>

            <div class="row">
              <div class="col-md-6">
                <div class="card p-3 mb-3">
                  <strong>VVPAT Preview</strong>
                  <div id="vvpat" class="mt-2"></div>
                </div>
                <div id="qrcode" class="mb-3"></div>
                <div class="d-flex gap-2">
                  <button id="btnFinish" class="btn btn-primary">Finish</button>
                  <button id="btnViewLedger" class="btn btn-outline-secondary">View Ledger</button>
                </div>
              </div>
              <div class="col-md-6">
                <div id="ledgerView" style="display:none;">
                  <h6>Local Ledger</h6>
                  <pre id="ledgerPre" style="max-height:320px;overflow:auto;background:#f6f8ff;padding:12px;border-radius:8px;"></pre>
                </div>
              </div>
            </div>
          </div>

        </div><!-- card -->
      </div>
    </div>
  </div>

<script>
/* ============================
   Enhanced EVM-like Voting Demo
   ============================
   - face-api.js for face recognition
   - WebCrypto RSA-OAEP for encrypting vote (simulated authority)
   - SHA-256 chain for tamper-evidence
   - localStorage used to simulate DB/ledger
   - Not production-grade; for demo/presentation only
*/

const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models/'; // public demo models host

// Utility
const $ = sel => document.querySelector(sel);
const byId = id => document.getElementById(id);

// Initial sample candidates
const candidates = [
  { id:'C1', name:'Candidate A', party:'Alpha' },
  { id:'C2', name:'Candidate B', party:'Beta' },
  { id:'C3', name:'Candidate C', party:'Gamma' }
];

// Local storage keys
const LS = {
  LEDGER: 'lavis_ledger_v1',
  TEMPLATE_PREFIX: 'lavis_template_', // + voterId
  VOTED_PREFIX: 'lavis_voted_',       // + voterId
  AUTHORITY_KEYS: 'lavis_authority_keys_v1' // stores publicKey (JWK) and privateKey (JWK) for demo
};

// State
let currentVoter = null;
let refDescriptor = null; // Float32Array face descriptor
let liveDescriptor = null;
let cameraStream = null;
let authorityPublicKey = null;
let authorityPrivateKey = null;

// --- Initialize UI & models ---
async function init(){
  // populate candidate UI
  const area = $('#candidateArea');
  candidates.forEach(c=>{
    const btn = document.createElement('button');
    btn.type='button';
    btn.className='list-group-item list-group-item-action';
    btn.dataset.id = c.id;
    btn.innerHTML = `<div class="d-flex w-100 justify-content-between"><div><strong>${c.name}</strong><div class="small-muted">${c.party}</div></div><small>${c.id}</small></div>`;
    btn.onclick = ()=> {
      document.querySelectorAll('#candidateArea .list-group-item').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
    };
    area.appendChild(btn);
  });

  // ensure ledger exists
  if(!localStorage.getItem(LS.LEDGER)) localStorage.setItem(LS.LEDGER, JSON.stringify([]));

  // load or generate authority keypair (simulate Election Authority RSA key)
  await ensureAuthorityKeypair();

  // load face-api models
  await Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
  ]);

  $('#modelsNotice').classList.remove('alert-info');
  $('#modelsNotice').classList.add('alert-success');
  $('#modelsNotice').textContent = 'Models ready. You can begin the flow.';
  gsap.from('#modelsNotice', {y:-10, opacity:0, duration:0.6});
}
init().catch(err=>{ console.error(err); $('#modelsNotice').textContent='Model load failed: '+err.message; });

// -------------------------- Authority keypair (WebCrypto) --------------------------
async function ensureAuthorityKeypair(){
  const saved = localStorage.getItem(LS.AUTHORITY_KEYS);
  if(saved){
    try{
      const obj = JSON.parse(saved);
      authorityPublicKey = await crypto.subtle.importKey('jwk', obj.publicKey, {name:'RSA-OAEP', hash:'SHA-256'}, true, ['encrypt']);
      authorityPrivateKey = await crypto.subtle.importKey('jwk', obj.privateKey, {name:'RSA-OAEP', hash:'SHA-256'}, true, ['decrypt']);
      console.log('Loaded authority keys from storage.');
      return;
    }catch(e){ console.warn('Failed to import stored keys, will generate new.'); }
  }
  // generate new
  const kp = await crypto.subtle.generateKey(
    { name: 'RSA-OAEP', modulusLength: 2048, publicExponent: new Uint8Array([1,0,1]), hash: 'SHA-256' },
    true,
    ['encrypt','decrypt']
  );
  const pubJwk = await crypto.subtle.exportKey('jwk', kp.publicKey);
  const privJwk = await crypto.subtle.exportKey('jwk', kp.privateKey);
  localStorage.setItem(LS.AUTHORITY_KEYS, JSON.stringify({ publicKey: pubJwk, privateKey: privJwk }));
  authorityPublicKey = kp.publicKey;
  authorityPrivateKey = kp.privateKey;
  console.log('Generated new authority keypair for demo.');
}

// -------------------------- Helpers: ledger & hashing --------------------------
async function sha256hex(str){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
}
function getLedger(){ return JSON.parse(localStorage.getItem(LS.LEDGER) || '[]'); }
function saveLedger(ledger){ localStorage.setItem(LS.LEDGER, JSON.stringify(ledger)); }

// -------------------------- UI Actions --------------------------
$('#btnLoadSample').addEventListener('click', ()=> {
  $('#voterInput').value = 'VOTER_1001';
});

$('#btnStartAuth').addEventListener('click', async ()=>{
  const id = $('#voterInput').value.trim();
  if(!id){ $('#voterStatus').innerHTML = '<span class="text-danger">Enter a Voter ID.</span>'; return; }
  currentVoter = id;
  $('#voterStatus').innerHTML = `<span class="text-primary">Voter "${id}" inserted. Checking template...</span>`;

  // if already voted -> block
  if(localStorage.getItem(LS.VOTED_PREFIX + id)){
    $('#voterStatus').innerHTML = `<span class="text-danger">This voter has already voted — EVM locked.</span>`;
    return;
  }

  // check for stored reference template
  const saved = localStorage.getItem(LS.TEMPLATE_PREFIX + id);
  if(saved){
    // load template image and its descriptor
    const obj = JSON.parse(saved);
    const desc = new Float32Array(Object.values(obj.descriptor));
    refDescriptor = desc;
    // draw preview
    const img = new Image();
    img.onload = ()=> {
      const c = $('#refCanvas'); const ctx = c.getContext('2d');
      ctx.clearRect(0,0,c.width,c.height);
      ctx.drawImage(img,0,0,c.width,c.height);
      $('#voterStatus').innerHTML = `<span class="text-success">Template found. Proceed to live verification.</span>`;
      showStep(3);
    };
    img.src = obj.dataUrl;
  } else {
    // no template registered — ask to register
    $('#voterStatus').innerHTML = `<span class="text-warning">No template registered for this ID. Please register a reference photo.</span>`;
    showStep(2);
  }
});

// Register reference template by upload
$('#refFile').addEventListener('change', async (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = async ()=>{
    // draw to canvas small and compute descriptor
    const canvas = $('#refCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
    const single = await faceapi.detectSingleFace(canvas, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
    if(!single){ alert('No face detected in reference image. Use a clear frontal image.'); return; }
    refDescriptor = single.descriptor;
    // Save template to localStorage (dataURL + descriptor numeric array)
    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
    const payload = { dataUrl, descriptor: Array.from(refDescriptor) };
    localStorage.setItem(LS.TEMPLATE_PREFIX + currentVoter, JSON.stringify(payload));
    $('#voterStatus').innerHTML = `<span class="text-success">Reference template saved for ${currentVoter}. Proceed to live verification.</span>`;
  };
  img.src = url;
});

$('#btnUseCameraRef').addEventListener('click', async ()=>{
  // start camera, capture a frame into refCanvas as template
  await startCamera();
  alert('Camera started — click "Capture" in live verification to use current frame as reference, then click "Save as Reference" in the UI.');
  // show step-3 camera UI and instruct user to capture then save as reference
  showStep(3);
});

// Proceed to camera verification
$('#btnProceedCam').addEventListener('click', ()=> showStep(3));

// Start camera
async function startCamera(){
  try{
    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
    $('#video').srcObject = cameraStream;
  }catch(e){ alert('Camera access required: ' + e.message); }
}

// Capture live frame
$('#btnCaptureLive').addEventListener('click', async ()=>{
  if(!cameraStream){ await startCamera(); }
  const v = $('#video');
  const canvas = $('#liveCanvas');
  const ctx = canvas.getContext('2d');
  ctx.drawImage(v, 0,0, canvas.width, canvas.height);
  $('#matchResult').textContent = 'Captured. Running recognition...';
  // detect face & descriptor
  const detection = await faceapi.detectSingleFace(canvas, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
  if(!detection){ $('#matchResult').innerHTML = '<span class="text-danger">No face detected. Try again.</span>'; return; }
  liveDescriptor = detection.descriptor;
  // if no reference yet and user wants to treat this as reference (when came from Use Camera Ref)
  const maybeSaveRef = !refDescriptor && confirm('No reference template found. Save this capture as reference template for this voter? (OK = save)');
  if(maybeSaveRef){
    refDescriptor = liveDescriptor;
    const c = $('#refCanvas'); const ctxRef = c.getContext('2d');
    ctxRef.drawImage($('#liveCanvas'),0,0,c.width,c.height);
    const dataUrl = c.toDataURL('image/jpeg',0.85);
    const payload = { dataUrl, descriptor: Array.from(refDescriptor) };
    localStorage.setItem(LS.TEMPLATE_PREFIX + currentVoter, JSON.stringify(payload));
    $('#voterStatus').innerHTML = `<span class="text-success">Reference captured & saved for ${currentVoter}.</span>`;
  }
  // if we already have refDescriptor, compute distance
  if(refDescriptor){
    const dist = faceapi.euclideanDistance(refDescriptor, liveDescriptor);
    $('#matchResult').innerHTML = `Match distance: <strong>${dist.toFixed(3)}</strong> (threshold demo: 0.55)`;
    if(dist <= 0.55){
      $('#matchResult').innerHTML += ' — <span class="text-success">Verified</span>';
      // unlock EVM
      unlockEVMForVoter(currentVoter);
    } else {
      $('#matchResult').innerHTML += ' — <span class="text-danger">Mismatch</span>';
    }
  }
});

// Retry: clear live canvas
$('#btnRetryCapture').addEventListener('click', ()=> {
  const c = $('#liveCanvas'); c.getContext('2d').clearRect(0,0,c.width,c.height);
  $('#matchResult').textContent = '';
});

// unlockEVM: create ephemeral session token and reveal EVM
async function unlockEVMForVoter(voterId){
  // create a one-time session token (random)
  const token = crypto.getRandomValues(new Uint8Array(16));
  const tokenHex = Array.from(token).map(b=>b.toString(16).padStart(2,'0')).join('');
  // show unlocked UI
  $('#evmLockStatus').textContent = 'Unlocked';
  $('#evmLockStatus').className = 'status-pill bg-success text-white';
  $('#evmLockedMsg').style.display = 'none';
  $('#evmScreen').style.display = 'block';
  $('#evmLockedMsg').style.display = 'none';
  // show step 4
  $('#step-3').style.display = 'none';
  $('#step-4').style.display = 'block';
  gsap.from('#step-4', { y: 12, opacity:0, duration:0.5 });
  // store ephemeral to state (for demo only)
  window._lavis_session = { voterId, token: tokenHex, expires: Date.now() + (5*60*1000) }; // 5 min session
}

// Cast vote
$('#btnCastVote').addEventListener('click', async ()=>{
  // ensure session unlocked
  if(!window._lavis_session || window._lavis_session.voterId !== currentVoter){
    alert('EVM not unlocked for this voter.');
    return;
  }
  // check double-vote
  if(localStorage.getItem(LS.VOTED_PREFIX + currentVoter)){
    alert('This voter already cast a vote. EVM locked.');
    return;
  }
  const chosen = document.querySelector('#candidateArea .active');
  if(!chosen){ alert('Select candidate'); return; }
  const candidateId = chosen.dataset.id;
  const candidate = candidates.find(c=>c.id===candidateId);
  // build plaintext record (we won't store voterId plaintext on VVPAT)
  const timestamp = new Date().toISOString();
  const recordPlain = JSON.stringify({ candidateId, timestamp, session: window._lavis_session.token });
  // encrypt vote with authority public key
  const enc = await crypto.subtle.encrypt({ name: 'RSA-OAEP' }, authorityPublicKey, new TextEncoder().encode(recordPlain));
  const encB64 = arrayBufferToBase64(enc);
  // compute previous hash and new hash chain entry
  const ledger = getLedger();
  const prevHash = ledger.length ? ledger[ledger.length-1].voteHash : 'GENESIS';
  const voteHash = await sha256hex(prevHash + '|' + encB64);
  const entry = { voteHash, encrypted: encB64, previousHash: prevHash, timestamp };
  ledger.push(entry);
  saveLedger(ledger);
  // mark voter as voted (store hashed id to avoid raw PII)
  sha256hex(currentVoter).then(h=>{
    localStorage.setItem(LS.VOTED_PREFIX + currentVoter, JSON.stringify({ votedAt: timestamp, voterHash: h }));
  });
  // Show VVPAT and QR
  $('#vvpat').innerHTML = `<div><strong>VVPAT</strong><div>Candidate: <strong>${candidate.name}</strong></div><div>Time: ${timestamp}</div><div>Vote Hash: <small>${voteHash}</small></div></div>`;
  document.getElementById('qrcode').innerHTML = '';
  new QRCode(document.getElementById('qrcode'), { text: voteHash, width:160, height:160 });
  // Show step 5
  $('#evmScreen').style.display = 'none';
  $('#step-5').style.display = 'block';
  $('#evmLockedMsg').style.display = 'none';
  $('#evmLockStatus').textContent = 'Locked';
  $('#evmLockStatus').className = 'status-pill bg-warning text-dark';
  // stop camera to free resource
  stopCamera();
  gsap.from('#step-5', { y:12, opacity:0, duration:0.5 });
});

// Cancel vote: go back to camera
$('#btnCancelVote').addEventListener('click', ()=> {
  // relock and return to verification
  $('#evmScreen').style.display = 'none';
  $('#step-3').style.display = 'block';
  $('#evmLockStatus').textContent = 'Locked';
  $('#evmLockStatus').className = 'status-pill bg-warning text-dark';
});

// Finish flow
$('#btnFinish').addEventListener('click', ()=> {
  alert('Vote recorded locally in ledger. Demo finished.');
  location.reload();
});

// View ledger
$('#btnViewLedger').addEventListener('click', ()=>{
  const ledgerDiv = $('#ledgerView');
  ledgerDiv.style.display = ledgerDiv.style.display === 'none' ? 'block' : 'none';
  $('#ledgerPre').textContent = JSON.stringify(getLedger(), null, 2);
});

// Stop camera
function stopCamera(){
  if(cameraStream){ cameraStream.getTracks().forEach(t=>t.stop()); cameraStream = null; $('#video').srcObject = null; }
}

// Helper: arrayBuffer => base64
function arrayBufferToBase64(buffer){
  const bytes = new Uint8Array(buffer);
  let binary = '';
  for(let i=0;i<bytes.byteLength;i++){
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

// Show step helper
function showStep(n){
  // n = 2 -> show step-2 etc
  document.getElementById('step-2').style.display = (n===2)?'block':'none';
  document.getElementById('step-3').style.display = (n===3)?'block':'none';
  document.getElementById('step-4').style.display = (n===4)?'block':'none';
}

// beforeunload stop camera
window.addEventListener('beforeunload', ()=> stopCamera());

</script>
</body>
</html>
